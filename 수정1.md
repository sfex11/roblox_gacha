# 수정 내역 요약 (Rojo + Studio MCP + AI UGC)

## 0) 배경/문제

- Rojo로 Roblox Studio와 프로젝트를 동기화하며 가챠 게임 개발 중.
- AI로 생성한 UGC를 착용하려고 했지만 계속 실패했고(Attachment/Accessory 타입/assetId/InsertService 등), 채팅 커맨드도 환경(TextChatService) 때문에 안 먹는 증상이 있었음.
- UGC 모델이 너무 단순(구체 폴백)해서 “LLM(스펙) 기반으로 자동으로 멋지게 생성”까지 기능 완성을 원함.

---

## 1) 런타임 UGC 착용 안정화

### `src/ServerScriptService/UGCEquipService.lua`

- 장착 우선순위 추가:
  1) `ServerStorage.UGCAssets` 또는 `ReplicatedStorage.UGCAssets`에 **링크된 Accessory**가 있으면 그걸 Clone해서 장착
  2) `assetId`가 있으면 `InsertService:LoadAsset(assetId)`로 장착 시도
  3) 실패 시 `HumanoidDescription` 방식으로 장착 시도
  4) 모두 실패하면 폴백(절차적/구체)
- `assetId` 문자열/`rbxassetid://...` 형태도 숫자로 정규화.
- `UGCType → AttachmentName` 매핑 보강(Back/Front/Shoulder/Waist 등).
- `Humanoid:AddAccessory`를 `pcall`로 감싸서 실패 시 로그 출력 + 롤백 안전하게 처리.

### `src/ServerScriptService/init.server.lua`

- 인벤토리에서 UGC 장착 요청(`RequestEquip`)이 들어오면:
  - `InventoryService.Equip()` 후, UGC면 `UGCEquipService.Equip()`을 호출
  - 장착 실패 시 `InventoryService.Unequip(Constants.Category.UGC)`로 롤백
- UGC 해제(`RequestUnequip`) 시 실제 Accessory도 제거하도록 `UGCEquipService.Unequip()` 호출.

---

## 2) Studio에서 UGC 링크(런타임 장착용) 도구 추가

### `src/ServerScriptService/UGCTools.lua`

- Accessory를 런타임에서 확실히 장착하려면, **Studio에서 생성한 Accessory**를 `UGCAssets` 폴더에 “templateId”로 링크해둬야 함.
- 추가된 함수:
  - `UGCTools.LinkSelectedAccessory(templateId, { destination = "ServerStorage" | "ReplicatedStorage" })`
  - `UGCTools.LinkAccessory(accessory, templateId, options)`
  - `UGCTools.LinkAccessoryByName(templateId, accessoryName, options)`
- 링크 시 `Accessory:SetAttribute("UGC_TemplateId", templateId)`를 저장하고, Script/LocalScript는 제거하여 안전하게 보관.

---

## 3) 채팅 커맨드가 안 먹는 문제(TextChatService) 대응

### `src/ServerScriptService/UGCPipeline.lua`

- Roblox 신형 채팅(TextChatService)에서는 `Player.Chatted`가 안 타는 경우가 있어,
  - Legacy: `player.Chatted`
  - New: `TextChatService.OnIncomingMessage`
  로 분기 처리.
- 테스트/운영 편의 커맨드:
  - `!ugc_make <프롬프트>`: FBX 생성(백엔드) + Import 가이드 출력 + DB 등록
  - `!ugc_list`: 등록된 UGC 목록 출력
  - `!ugc_refresh`: 가챠 풀 리프레시
  - `!ugc_give <templateId>`: 인벤에 즉시 지급
  - `!ugc_equip <templateId>`: 지급 + 즉시 장착

---

## 4) “UGC 너무 단순” 문제 해결: LLM 스펙 기반 Procedural UGC 완성

### 핵심 아이디어

- Roblox는 “FBX Import 완전 자동화”가 불가능/제약이 커서, **게임 내에서 바로 착용 가능한** Procedural UGC 생성 루트를 추가.
- 백엔드에서 “모델링 스펙(JSON)”만 받아도, 그 스펙의 `shape/style/motifs/vfx` 힌트로 **여러 파트를 조합한 액세서리**를 생성.

### `src/ServerScriptService/UGCProceduralBuilder.lua`

- `templateId` 기반 seed로 **항상 같은 아이템은 같은 외형**이 나오도록 설계.
- `ugcType`별 빌더 구현(예: Hat/Back/Face/Waist/Shoulder/Front/Hair).
- 희귀도에 따라 디테일/장식/이펙트(빛/스파클/불 등) 강도를 높임.
- `motifs` 힌트(예: `cat_ears`, `crown`, `wings`, `helmet`, `cyber`, `space`, `embers`, `lightning`)를 반영해 형태를 다르게 생성.

### `src/ServerScriptService/UGCEquipService.lua`

- 기존 “구체 1개” 폴백 대신, Procedural Builder를 먼저 호출:
  - `UGCProceduralBuilder.BuildAccessory(...)`
  - 실패할 경우에만 “구체 폴백” 사용.

### `src/ServerScriptService/UGCPipeline.lua`

- **스펙만 생성해서 즉시 착용 가능한 UGC 생성 함수** 추가:
  - `UGCPipeline.GenerateProceduralUGC(prompt, options)`
- 신규 커맨드:
  - `!ugc_gen [<category>] [<rarity>] <프롬프트...>`
  - 생성 → UGC 등록 → 가챠 풀 갱신 → (테스트 편의) **인벤 지급 + 즉시 장착**

### `src/ReplicatedStorage/Modules/UGCDatabase.lua`

- UGC 아이템에 `visualSpec` 저장 필드 추가(절차적 생성용).
- 백엔드 API 스펙/응답에서 생성된 spec을 `visualSpec`으로 보관 가능.

---

## 5) 인벤토리 UI에서 “동적 UGC”가 잘 보이도록 동기화

문제: 클라이언트가 `ItemDatabase.Init()` 시점에만 UGC를 인덱싱해서, 런타임에 등록된 UGC가 UI에서 누락될 수 있음.

### `src/ServerScriptService/init.server.lua`

- `RequestInventory` 응답에 `templates`(템플릿 메타) 포함:
  - `{ inventory, equipped, templates = { [templateId] = {id,category,rarity,name,description,flavorText,ugcType} } }`

### `src/StarterPlayer/StarterPlayerScripts/GachaClient/InventoryUI.lua`

- `InventoryUI.Refresh(inventory, equipped, templatesById)`로 변경
- 서버가 보내준 템플릿을 우선 사용 → 런타임 UGC도 이름/설명/희귀도 색상 정상 표시.

### `src/StarterPlayer/StarterPlayerScripts/GachaClient/init.client.lua`

- `RequestInventory` 호출 후 `InventoryUI.Refresh(..., data.templates)`로 연결.

---

## 6) 백엔드/문서 개선

### `backend/src/server.js`

- `/exports` 정적 서빙 경로를 실제 `backend/exports`로 수정.
- 서버 바인딩을 `127.0.0.1`로 고정(로컬 전용).

### `backend/src/services/blenderService.js`

- 모델링 스펙 프롬프트에 `motifs`, `vfx`, `seed` 필드를 포함하도록 개선(Procedural 생성에도 바로 활용 가능).
- Attachment 매핑 보강(Front/Back/Shoulder/Waist 등).

### 문서

- `STUDIO_MCP_GUIDE.md`: FBX Import 루트 + “FBX 없이 즉시 생성(!ugc_gen)” 루트 추가.
- `README.md`: `!ugc_gen` 사용법/환경 변수(`ZAI_API_KEY` 등) 설명 보강.

---

## 7) MCP로 직접 점검한 결과(Studio 쪽)

- MCP(127.0.0.1:44755) 연결은 정상(`STATUS connected: true`).
- Studio 데이터모델에 `ServerScriptService.GachaServer.UGCPipeline`, `UGCEquipService`, `UGCTools`는 존재 확인.
- `TextChatService.ChatVersion=TextChatService` 환경임을 확인(신형 채팅이므로 OnIncomingMessage 훅이 필요).
- 다만, **Studio 내부 `UGCProceduralBuilder` ModuleScript require 시** `Module code did not return exactly one value` 오류가 발생한 케이스가 있었음:
  - 원인 후보: Studio에 “RunCode로 큰 소스”를 주입하는 과정에서 소스가 깨지거나 잘려서 실행 종료(리턴 미실행)되는 상황.
  - 권장: Studio는 **Rojo 동기화(rojo serve → Studio Rojo plugin)**로 최신 소스를 반영하는 방식이 가장 안정적.

---

## 8) 지금 사용법(추천)

1) 백엔드 실행: `cd backend && npm run dev`
2) Studio: `Allow HTTP Requests` 켜기
3) 플레이 후 채팅:
   - `!ugc_gen Hat Epic cyber cat crown`
   - `!ugc_gen Back Legendary 천사 날개 제트팩`
4) 인벤토리에서 아이템 클릭으로 장착/해제 확인

---

## 9) 아직 남은 것(제약 포함)

- FBX Import 자체는 Roblox API 제약으로 완전 자동화 불가(반자동 유지).
- Roblox 카탈로그 퍼블리시/업로드 자동화는 `UGCAutoUpload.lua`가 Placeholder 상태(향후 Studio Plugin/워크플로우 필요).

---

## 10) Git 상태

- 로컬 `main` 브랜치가 `origin/main`보다 5 commits 앞서 있음(푸시 대기).
- 가장 최신 커밋: `aa6ccf9 feat: procedural UGC generation + equip pipeline`
- 이 실행 환경에서는 `git push origin main` 실행 시 DNS 문제로 `github.com` 해석 실패(`Could not resolve host`)가 발생하여 푸시 불가.
  - 해결: 네트워크가 되는 터미널/환경에서 `git push origin main` 수행.
- 워킹트리에 추적되지 않은 파일(개인 메모/참고용)이 몇 개 남아 있음(커밋/무시 여부는 선택).
